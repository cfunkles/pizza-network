<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script
        src="http://code.jquery.com/jquery-3.2.1.js"
        integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE="
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="./index.css">
    <title>*Home*</title>
</head>
<body>
    <div class="innerBody">
        <nav class="navbar navbar-inverse navbar-static-top">
            <div class="container-fluid">
                <div class="navbar-header">
                    <a href="#" class="navbar-brand info-button">
                        <!--placeholder image for future logo-->
                        <img src="http://www.hey.fr/fun/emoji/android/en/icon/android/227-emoji_android_slice_of_pizza.png" alt="firebrick-logo">
                    </a>
                    <!--Create better title style the shit out of this!-->
                    <h4 id='site-name'>Pizza-Network</h4>
                </div>
                <ul class="nav navbar-nav navbar-right">
                    <!--To Do: change to buttons, customize the sytle more-->
                    <li class="active"><a href="home.html">Home</a></li>
                    <li><a href="complete.html">Complete Pizzeria List</a> </li>
                    <li><a href="chats.html">The Slicial Network</a></li>
                </ul>
            </div>
        </nav>

        <section id="hiddenStuff" style="display: none">
            <div class="container info">
                <div class="row">
                    <p class="col-sm-6 col-sm-offset-3">Pizza network is a site for people who love pizza! Members can add new pizza places, vote for their favorite spot, find your style of pizza, and talk with other humans about pizza. Enjoy you're Pizzazzzing!!!</p>
                </div>
                <div class="center">
                    <button class="btn btn-primary clearHidden">Exit</button>
                </div>
            </div>
        </section>
        <div id="stuffToHide">
            <!--template to build pizza places-->
            <div id="pizzeriahomeTemplate" style="display: none">
                <div class="well pizzeria">
                    <div class="row">
                        <!-- pizzeria name get hypertext to their profile -->
                        <span class="col-md-8">
                            <h3 class="pizzaName"></h3>
                        </span>
                        <span class="col-md-2">
                            <button class="btn btn-warning upper">Up Slice
                                <p class="upVotes"></p>
                            </button>
                        </span>
                        <span class="col-md-2">
                            <button class="btn btn-warning downer">Down Slice
                                <p class="downVotes"></p>
                            </button>
                        </span>
                    </div>
                    <hr>
                    <div class="row center">
                        <div class="address col-md-3"></div>
                        <span class="col-md-2">
                            <p class="pizzaTel"></p>
                        </span>
                        <span class="col-md-3">
                            <a href="" class="pizzaURL" target="_blank"></a>
                        </span>
                    </div>
                    <hr>
                    <!-- alter output to soimething boolean friendly -->
                    <div class="row pizzaDetails center">
                        <span class="col-md-2">New York: <p class="pizzaNY"></p></span>
                        <span class="col-md-2">Deep Dish: <p class="pizzaDD"></p></span>
                        <span class="col-md-2">Brick Oven: <p class="pizzaBO"></p></span>
                        <span class="col-md-2">Authentic: <p class="pizzaAU"></p></span>
                        <span class="col-md-2">Delivers: <p class="pizzaDel"></p></span>
                        <span class="col-md-2">Kid Friendly: <p class="pizzaKids"></p></span>
                    </div>
                </div>
            </div>
            
            <!--output for the topten-->
            <div class="container">
                <h2 class="list_title">Top Ten Pizzerias</h2>
                <div id="output"></div>
            </div>

            <div class="container well create-form">
                <div class="row pizzaCreate">
                    <p class="col-md-5 col-md-offset-2">Do you have a pizzeria that you'd like to add to the list?</p>
                    <button class="btn btn-warning col-md-2 newPizzaCreate">Click To Add</button>
                </div>
        		<div class="row newPizzaPlace" style="display: none">
        			<div class="col-sm-4 col-sm-offset-4">
                        <h3>Fill in the form below to add a new pizzeria.</h3>
        				Name: <input type="text" id="newPizzaName" class="form-control">
        				Telephone: <input type="text" id="newPizzaTel" class="form-control">
        				URL: <input type="text" id="newPizzaSite" class="form-control">
                        Address: <input type="text" id="newPizzaAdd" class="form-control">
                        City: <input type="text" id="newPizzaCity" class="form-control">
                        State: <input type="text" id="newPizzaState" class="form-control">
                        Zip: <input type="text" id="newPizzaZip" class="form-control"> 
                        <!-- fix the radio buttons so that they unselect -->
        				<h4>Pizza Styles:</h4>
                        <div class="pizzaStyles">
                            New York:
                            <input type="radio" name="newYork" value="yes"> Yes
                            <input type="radio" name="newYork" value="no"> No<br>
                            Deep Dish:
                            <input type="radio" name="deepDish" value="yes"> Yes
                            <input type="radio" name="deepDish" value="no"> No<br>
                            Brick Oven:
                            <input type="radio" name="brickOven" value="yes"> Yes
                            <input type="radio" name="brickOven" value="no"> No<br>
                            Authentic:
                            <input type="radio" name="authentic" value="yes"> Yes
                            <input type="radio" name="authentic" value="no"> No<br>
                        </div>
                        <div class="additionalOptions">
                            <h4>Delivery:</h4>
                            <input type="radio" name="delivery" value="yes"> Yes
                            <input type="radio" name="delivery" value="no"> No<br>
                            <h4>Kid Friendly:</h4>
                            <input type="radio" name="kids" value="yes"> Yes
                            <input type="radio" name="kids" value="no"> No<br>
                        </div><br>
                        <button class="btn btn-warning" id="newPizzaSubmit">Submit Pizzeria</button>
        			</div>
        		</div>
        	</div>
            <br>
        </div>
        <footer class="center">
            <p>The Pizza Network &copy; 2017 Casey, Chuck, David</p>
        </footer>
    </div>
    <script>
        // Check for authentication and call popular sort
        $(document).ready(function() {
            $.get('/api/authentication', function(data){
                if(data === "error"){
                    window.location.href = "index.html";
                }
            });
            popularSort();
        });
        
        // Template function for cloning pizza divs
        function template(response) {
            $('#output').empty();
            for (var i = 0; i < response.length; i++) {
                var pizzaDiv = $('#pizzeriahomeTemplate').children().clone();
                pizzaDiv.find('.pizzaName').text(response[i].name);
                //format for phone numbers
                pizzaDiv.find('.pizzaTel').text(response[i].phone);
                pizzaDiv.find('.address').text(response[i].address + "\n" + response[i].city + ", " +response[i].state + ' ' + response[i].zip);
                pizzaDiv.find('.pizzaURL').attr('href', response[i].url);
                pizzaDiv.find('.pizzaURL').text(response[i].url);
                //consider different output format for these booleans
                pizzaDiv.find('.pizzaNY').text(response[i].newYork);
                pizzaDiv.find('.pizzaDD').text(response[i].deepDish);
                pizzaDiv.find('.pizzaBO').text(response[i].brickOven);
                pizzaDiv.find('.pizzaAU').text(response[i].authentic);
                pizzaDiv.find('.pizzaDel').text(response[i].delivery);
                pizzaDiv.find('.pizzaKids').text(response[i].kids);
                pizzaDiv.find('.upVotes').text(response[i].upVotes);
                pizzaDiv.find('.upper').click(upListener(response[i]));
                pizzaDiv.find('.downVotes').text(response[i].downVotes);
                pizzaDiv.find('.downer').click(downListener(response[i]));
                $('#output').append(pizzaDiv);
            }
        }

        // Get pizzas and sort by popularity. Show only ten
        function popularSort(data) {
            $.ajax({
                method: 'GET',
                url: 'api/getPizzerias', 
                success: function(data) {
                    var popular = [];
                    for (var i = 0; i < data.length; i++) {
                        popular.push(data[i]);
                    }
                    popular.sort(function(a, b) {
                        return b.score - a.score;
                    });
                    popular.splice(10);
                    template(popular);
                },
                error: function(err) {
                    $('#pizzeriahome').text('500 internal server error!');
                }
            });
        }

        // Click listener for up voting pizza places
        function upListener(pizzeria) {
            return function() {
                $.post('/api/upvote', {_id: pizzeria._id}, function(data) {
                    popularSort();
                });
            };
        }

        // Click listener for down voting pizza places
        function downListener(pizzeria) {
            return function() {
                $.post('/api/downvote', {_id: pizzeria._id}, function(data) {
                    popularSort();
                });
            };
        }

        // Click listener for showing more pizza details. Currently not in use.
        function detailsListener(pizzeria) {
            return function() {
                pizzaDiv.find('.details').slideDown('slow', function() {
                    getPizzerias();
                }); 
            };
        }

        // Pizza profile creation
        $('.newPizzaCreate').click(function() {
            $('.pizzaCreate').slideUp('fast', function() {
                $('.newPizzaPlace').slideDown('slow', function() {
                });
            });
        }); 

        // Post a new pizza place
        $('#newPizzaSubmit').click(function() {
            $.post('/api/newPlace', {
                name: $('#newPizzaName').val(),
                address: $('#newPizzaAdd').val(),
                city: $('#newPizzaCity').val(),
                state: $('#newPizzaState').val(),
                zip: $('#newPizzaZip').val(),
                phone: $('#newPizzaTel').val(),
                url: $('#newPizzaSite').val(),
                newYork: $('input[name=newYork]:checked').val(),
                deepDish: $('input[name=deepDish]:checked').val(),
                brickOven: $('input[name=brickOven]:checked').val(),
                authentic: $('input[name=authentic]:checked').val(),
                delivery: $('input[name=delivery]:checked').val(),
                kids: $('input[name=kids]:checked').val(),
                upVotes: 0,
                downVotes: 0,
                score: 0
            }, function () { // clear the form after it is submitted
                $('#newPizzaName').val('');
                $('#newPizzaAdd').val('');
                $('#newPizzaCity').val('');
                $('#newPizzaState').val('');
                $('#newPizzaZip').val('');
                $('#newPizzaTel').val('');
                $('#newPizzaSite').val('');
                // Rest radio buttons
                $('input[type=radio]').prop('checked', function () {
                    return this.getAttribute('checked') === 'checked';
                });
                $('.newPizzaPlace').slideUp('slow', function() {
                });
                $('.pizzaCreate').slideDown('fast', function() {
                });
            });
        });

        function showHidden() {
            $('.info-button').click(function() {
                $('#stuffToHide').fadeOut();
                $('#hiddenStuff').fadeIn();
            });
        }

        function hideHidden() {
            $('.clearHidden').click(function() {
                $('#hiddenStuff').fadeOut();
                $('#stuffToHide').fadeIn();
            });
        }
        showHidden();
        hideHidden();
    </script>
</body>
</html>